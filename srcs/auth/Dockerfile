FROM python:3.9-bookworm
COPY deps/requirements.txt /app/
RUN pip install -r /app/requirements.txt

LABEL Author="Sarah Hicham Meftah"
LABEL Container="Authenticator/Authorizer"

ARG DB_NAME
ARG DB_USER
ARG DB_PASSWORD
ARG DB_HOST
ARG DB_PORT
ARG SECRET_KEY
ARG CLIENT_ID
ARG CLIENT_SECRET
ARG EMAIL_API_KEY
ARG EMAIL_DOMAIN
ARG HOST_ADDRESS
ARG RP_EMAIL
ARG AUTH_PORT


ENV DB_NAME=${DB_NAME}
ENV DB_USER=${DB_USER}
ENV DB_PASSWORD=${DB_PASSWORD}
ENV DB_HOST=${DB_HOST}
ENV DB_PORT=${DB_PORT}
ENV SECRET_KEY=${SECRET_KEY}
ENV CLIENT_ID=${CLIENT_ID}
ENV CLIENT_SECRET=${CLIENT_SECRET}
ENV EMAIL_API_KEY=${EMAIL_API_KEY}
ENV EMAIL_DOMAIN=${EMAIL_DOMAIN}
ENV HOST_ADDRESS=${HOST_ADDRESS}
ENV RP_EMAIL=${RP_EMAIL}
ENV AUTH_PORT=${AUTH_PORT}

ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

COPY JwtAuth/ /app
COPY tools/entrypoint.sh /app 

WORKDIR /app
COPY certs/c1r4p2.1337.ma.crt /app/
COPY certs/c1r4p2.1337.ma.key /app/

RUN mv c1r4p2.1337.ma.crt ${HOST_ADDRESS}.crt
RUN mv c1r4p2.1337.ma.key ${HOST_ADDRESS}.key


ENTRYPOINT [ "bash", "/app/entrypoint.sh" ]